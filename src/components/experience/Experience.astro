---
import ExperienceItem from "@/components/experience/ExperienceItem.astro";
import Arrow from "@/shared/components/Arrow.astro";
import HeaderSection from "@/shared/components/HeaderSection.astro";
import { useT } from "@/i18n/utils";
import { EXPERIENCE } from "@/consts/experience";

const t = useT();
---

<section id="experience" class="max-w-6xl mx-auto my-20 text-content">
	<Arrow color="gold" />
	<div class="flex flex-col items-center justify-center">
		<HeaderSection title="experience.title" />
		<div class="relative w-full max-w-4xl">
			<div
				id="experience-list"
				class="flex flex-col items-center w-full gap-5 mt-10 collapsed overflow-hidden transition-all p-6"
			>
				{
					EXPERIENCE.map(({ lugar, puesto, tiempo, descripcion }, index) => (
						<ExperienceItem
							index={index}
							lugar={lugar}
							puesto={puesto}
							tiempo={tiempo}
							descripcion={descripcion}
						/>
					))
				}
			</div>
			<div
				id="experience-list-fade"
				class="absolute h-25 w-full bottom-0 left-0 bg-gradient-to-b from-transparent to-background pointer-events-none"
			>
			</div>
		</div>
		<button
			id="btn-experience-list-collapse"
			class="mt-5 2xl:w-1/6 xl:w-1/4 lg:w-1/3 sm:w-1/2 w-full
			flex items-center justify-center text-sm text-neon border border-neon rounded px-4 py-2
			hover:bg-hover transition cursor-pointer"
		>
			<div class="flex items-center gap-2">
				<svg
					id="experience-arrow"
					class="size-6 text-neon -rotate-90"
					viewBox="0 0 24 24"
					fill="none"
				>
					<path
						d="M16.1795 3.26875C15.7889 2.87823 15.1558 2.87823 14.7652 3.26875L8.12078 9.91322C6.94952 11.0845 6.94916 12.9833 8.11996 14.155L14.6903 20.7304C15.0808 21.121 15.714 21.121 16.1045 20.7304C16.495 20.3399 16.495 19.7067 16.1045 19.3162L9.53246 12.7442C9.14194 12.3536 9.14194 11.7205 9.53246 11.33L16.1795 4.68297C16.57 4.29244 16.57 3.65928 16.1795 3.26875Z"
						fill="currentColor"></path>
				</svg>
			</div>
			<span id="span-btn-experience-list"> Mostrar más </span>
		</button>
	</div>
</section>

<style>
	#experience-list {
		transition: max-height 0.5s linear;
	}
	#experience-list.collapsed {
		max-height: 600px;
		overflow: hidden;
	}
	#experience-list.non-collapsed {
		max-height: max-content;
		overflow: visible;
	}
</style>

<script>
	let collapsedList: boolean = true;

	function delayClass(index: number): string {
		const base = "delay-0";

		const mdIndex = index % 2;
		const md = mdIndex === 0 ? "md:delay-150" : "md:delay-0";

		const lgIndex = index % 3;
		const lg = lgIndex === 0 ? "lg:delay-300" : lgIndex === 1 ? "lg:delay-150" : "lg:delay-0";

		return `${base} ${md} ${lg}`;
	}

	function applyDelayClass() {
		const $experienceArticles = document.querySelectorAll("div.experience-item");

		$experienceArticles.forEach((experience, index) => {
			experience.classList.add(...delayClass(index).split(" "));
		});
	}

	function updateToggleButtonText() {
		const $span = document.querySelector("#span-btn-experience-list");
		const lang = document.documentElement.lang || "en";
		const isCollapsed = collapsedList;

		if ($span && lang == "es" && !isCollapsed) {
			$span.textContent = "Mostrar menos";
		}
		if ($span && lang == "es" && isCollapsed) {
			$span.textContent = "Mostrar más";
		}
		if ($span && lang == "en" && !isCollapsed) {
			$span.textContent = "Show less";
		}
		if ($span && lang == "en" && isCollapsed) {
			$span.textContent = "Show more";
		}
	}

	function toggleCollapse() {
		const $containerList = document.querySelector("#experience-list");
		const $fade = document.querySelector("#experience-list-fade");
		const $arrow = document.querySelector("#experience-arrow");
		if (!$containerList) return;

		if (collapsedList) {
			$containerList.classList.remove("collapsed");
			$containerList.classList.add("non-collapsed");
			$fade?.classList.add("hidden");
			$fade?.classList.remove("block");
			$arrow?.classList.add("rotate-90");
			$arrow?.classList.remove("-rotate-90");
			collapsedList = false;
		} else {
			$containerList.classList.add("collapsed");
			$containerList.classList.remove("non-collapsed");
			$fade?.classList.remove("hidden");
			$fade?.classList.add("block");
			$arrow?.classList.remove("rotate-90");
			$arrow?.classList.add("-rotate-90");
			collapsedList = true;
		}
		updateToggleButtonText();
	}

	document.addEventListener("DOMContentLoaded", () => {
		applyDelayClass();
		updateToggleButtonText();

		const $btnCollapse = document.querySelector("#btn-experience-list-collapse");
		if ($btnCollapse) {
			$btnCollapse.addEventListener("click", (e) => {
				e.preventDefault();
				toggleCollapse();
			});
		}
	});

	document.addEventListener("languagechange", (event: any) => {
		updateToggleButtonText();
	});
</script>
